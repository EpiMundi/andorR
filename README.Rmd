---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# andorR

<!-- badges: start -->
[![R-CMD-check](https://github.com/EpiMundi/andorR/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/EpiMundi/andorR/actions/workflows/R-CMD-check.yaml)
<!-- badges: end -->

`andorR` (pronounced ‘Andorra’) is an R package for the analysis and optimization of expert system AND-OR decision trees. It helps manage the process of gathering evidence and reaching conclusions under uncertainty, aiming to minimize resource use and maximize confidence.

## About

AND-OR decision trees (also known as logic trees or Boolean decision trees) provide a structured way to implement expert systems in domains where repeatable, transparent, and standardized decision processes are critical, and where multiple pathways may lead to the same conclusion. Such trees are particularly valuable when decisions are based on a set of binary (TRUE/FALSE) criteria that can be combined using AND and OR logic.

Examples include **clinical diagnosis of complex or ambiguous diseases** (e.g., *Ottawa Ankle Rules*, *Centor criteria*, *Alvarado score*), **transparent policy decisions** (e.g., criteria for listing notifiable animal diseases by WOAH or selecting World Heritage sites by UNESCO), and **finance and investment management** (e.g., stage-gate systems and exclusionary screening).

In each case, determining an accurate answer to each criterion (a leaf in the tree) can require considerable resources (expensive tests, detailed research, extensive data collection). `andorR` addresses a critical gap for R users by:

1.  **Optimizing the path to a conclusion:** It calculates the "influence index" for each unanswered question, guiding the user to the most efficient sequence to reach a decision.
2.  **Managing uncertainty:** It propagates semi-quantitative confidence scores through the tree's logic, allowing for an overall confidence in the conclusion.
3.  **Guiding evidence generation:** For a partially resolved tree, it identifies which low-confidence answers are most critical to strengthen through further investigation to boost confidence in the final result.

While the R ecosystem has excellent packages for machine-learning-derived decision trees (e.g., `rpart`), `andorR` specifically caters to the interactive, evidence-gathering workflow of expert-defined logic trees, making complex decision processes transparent, reproducible, and resource-efficient.

## Installation

You can install `andorR` directly from GitHub:

```r
# install.packages("remotes") # If you don't have remotes installed
remotes::install_github("epimundi/andorR")
```

## Example Usage

Let's illustrate `andorR`'s core functionality by loading a predefined ethical investment decision tree, making some initial decisions, and then identifying the most influential remaining questions.

First, load the package and an example tree, and view the tree structure.

```{r basic-example, eval = TRUE}
library(andorR)
library(knitr)

# Load the example 'ethical' dataset
data(ethical)
tree <- load_tree_df(ethical)

# Initially, the tree is unresolved
print_tree(tree)
```

Get a list of the questions:

```{r basic-example-print-questions, eval = TRUE}
questions_df <- print_questions(tree)

display_df <- questions_df[, c("name", "question")]
colnames(display_df) <- c("ID", "Question")

kable(
  display_df,
  caption = "Ethical investment decision tree questions", 
  align = 'l',
  escape = TRUE,
  booktabs = TRUE
) 
```

Answer some questions

```{r basic-example-set-answer, eval = TRUE}

tree <- set_answer(tree, "FIN1", TRUE, 4) # Company shows consistent, high revenue growth (high confidence)
tree <- set_answer(tree, "ENV2", FALSE, 3) # Waste and water usage are NOT minimal (medium confidence)

# Update the tree to propagate answers and calculate influence indices
tree <- update_tree(tree)

# Print the updated tree
print_tree(tree)
```

Now that some questions are answered and the tree is updated, we can find the most influential remaining questions to answer to efficiently reach a conclusion. In this case we are sorting by "TRUE", a 'rule-in' approach which ranks influence assuming we respond TRUE. The other options are "FALSE" ('rule-out') and "BOTH" (unopinionated). 

```{r basic-example-get-influence, eval = TRUE}
# Get the top 10 most influential unanswered questions
highest_influence_questions <- get_highest_influence(tree, sort_by = "TRUE", top_n = 10)

display_df <- highest_influence_questions[, c("name", "influence_if_true", "influence_if_false", "question")]
colnames(display_df) <- c("ID", "Inf True", "Inf False", "Question")

kable(
  display_df,
  caption = "Priority questions based on 'rule-in' strategy", 
  align = 'l',
  escape = TRUE,
  booktabs = TRUE
) 

```

Answer more questions to complete the tree

```{r basic-example-answer-questions, eval = TRUE}
tree <- set_answer(tree, "ENV5", TRUE, 3, verbose=FALSE)
tree <- set_answer(tree, "SOC3", TRUE, 3, verbose=FALSE)
tree <- set_answer(tree, "FIN4", TRUE, 2, verbose=FALSE)
tree <- set_answer(tree, "FIN5", TRUE, 1, verbose=FALSE)
tree <- set_answer(tree, "GOV1", TRUE, 0, verbose=FALSE)
tree <- set_answer(tree, "GOV2", TRUE, 0, verbose=FALSE)
tree <- set_answer(tree, "GOV3", TRUE, 0, verbose=FALSE)
tree <- set_answer(tree, "GOV4", TRUE, 0, verbose=FALSE)
tree <- set_answer(tree, "GOV5", TRUE, 0, verbose=FALSE)

tree <- update_tree(tree)
print_tree(tree)
```

The conclusion for the investment decision is TRUE, but the confidence is very low.

Identify the most efficient questions to focus on to increase confidence.

```{r basic-example-get-boosters-1, eval = TRUE}
display_df <- get_confidence_boosters(tree)[, c("name", "action", "details", "potential_gain")]
colnames(display_df) <- c("ID", "Action", "Details", "Potential gain")

kable(
  display_df,
  caption = "Priority questions to increase confidence", 
  align = 'l',
  escape = TRUE,
  booktabs = TRUE
) 
```

All elements of Strong Corporate Governance are important in the tree, so more
research into the company is required in this area. Let's update the results
after having done a thorough assessment. 


```{r basic-example-update-questions-1, eval = TRUE}
tree <- set_answer(tree, "GOV1", TRUE, 5, verbose=FALSE)
tree <- set_answer(tree, "GOV2", TRUE, 5, verbose=FALSE)
tree <- set_answer(tree, "GOV3", TRUE, 5, verbose=FALSE)
tree <- set_answer(tree, "GOV4", TRUE, 5, verbose=FALSE)
tree <- set_answer(tree, "GOV5", TRUE, 5, verbose=FALSE)

tree <- update_tree(tree)
print_tree(tree)
```
Individually the impact was small but cumulatively the five questions gave a major
boost in confidence. Let's see what we should look at next. 

```{r basic-example-get-boosters-2, eval = TRUE}
display_df <- get_confidence_boosters(tree)[, c("name", "action", "details", "potential_gain")]
colnames(display_df) <- c("ID", "Action", "Details", "Potential gain")

kable(
  display_df,
  caption = "Priority questions to increase confidence", 
  align = 'l',
  escape = TRUE,
  booktabs = TRUE
) 
```

Let's do more research on Solvency and Stability, as suggested. 

```{r basic-example-update-questions-2, eval = TRUE}
tree <- set_answer(tree, "FIN4", TRUE, 5, verbose=FALSE)
tree <- set_answer(tree, "FIN5", TRUE, 5, verbose=FALSE)

tree <- update_tree(tree)
print_tree(tree)
```
This approach to strategic targeted research helps apply resources to the areas
where they will have the most impact on the overall conclusion. The process can
be repeated until the target level of confidence is reached. 

### Interactive tool

This manual iterative approach can get a little tedious. The `andorR_interactive()` function chains these actions together in a CLI interactive loop to automate the process. 

```
── andorR ──────────────────────────────────────────────────────────────────────────────
An analysis and optimisation tool for AND-OR decision trees.

Created by: EpiMundi (<https://epimundi.com>)
Author: Angus Cameron
Email: angus@epimundi.com
Version: 0.2.4

── Help Menu ───────────────────────────────────────────────────────────────────────────
h: Show this help message.
q: Quit the interactive session.
p: Print the current state of the tree.
s: Save the current tree state to an .rds file.
n: Specify a node to edit by typing its name.
1, 2, ...: Select a numbered question from the list to answer.
────────────────────────────────────────────────────────────────────────────────────────
────────────────────────────────────────────────────────────────────────────────────────

── Conclusion Reached! ──

The current result is: TRUE at a confidence of 57.6%
You can now answer more questions or revise existing answers to boost confidence.
────────────────────────────────────────────────────────────────────────────────────────
✔ Analysed 12 unanswered questions ✔  
✔ Analysed 4 existing answers ✔  

── Questions to Boost Confidence ──

1. [ENV4] Answer New Question Suggest answering TRUE +14.4%
2. [ENV6] Answer New Question Suggest answering TRUE +14.4%
3. [SOC1] Answer New Question Suggest answering TRUE +14.4%
4. [SOC2] Answer New Question Suggest answering TRUE +14.4%
5. [SOC4] Answer New Question Suggest answering TRUE +14.4%
6. [ENV5] Increase Confidence Current conf: 3/5 +14.4%
7. [SOC3] Increase Confidence Current conf: 3/5 +14.4%
8. [FIN2] Answer New Question Suggest answering TRUE +6.4%
9. [FIN3] Answer New Question Suggest answering TRUE +6.4%
10. [FIN1] Increase Confidence Current conf: 4/5 +6.4%
────────────────────────────────────────────────────────────────────────────────────────
Enter a number, 'n', or command (h, p, s, q): 

```

## API Documentation

Detailed documentation for all functions and their arguments can be found in the package's reference manual. You can access it in R using `?function_name` (e.g., `?update_tree`) or by visiting the `andorR` pkgdown website: [https://epimundi.github.io/andorR/](https://epimundi.github.io/andorR/)

## Community Guidelines

We welcome contributions, bug reports, and feature requests. Please follow these guidelines:

  * **Contributing:** If you'd like to contribute code, please open an issue first to discuss your proposed changes. Then, fork the repository, make your changes, and submit a pull request.
  * **Reporting Issues:** If you encounter any bugs or have suggestions for improvements, please open an issue on the [GitHub Issues page](https://github.com/EpiMundi/andorR/issues). Please provide a minimal reproducible example if reporting a bug.
  * **Seeking Support:** For questions about using `andorR` or for general support, you can also open an issue on the [GitHub Issues page](https://github.com/EpiMundi/andorR/issues).
